<svg viewBox="0 0 1000 670" xmlns="http://www.w3.org/2000/svg">
  <!-- Background and Title -->
  <rect width="1000" height="670" fill="#f8f9fa" rx="5" ry="5"/>
  <text x="500" y="40" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#2c3e50">Secure Data Processing Flow</text>
  
  <!-- Actors -->
  <rect x="100" y="100" width="100" height="550" rx="5" ry="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
  <text x="150" y="80" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">Client</text>
  
  <rect x="250" y="100" width="100" height="550" rx="5" ry="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
  <text x="300" y="80" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">API Gateway</text>
  
  <rect x="400" y="100" width="100" height="550" rx="5" ry="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
  <text x="450" y="80" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">IAM</text>
  
  <rect x="550" y="100" width="100" height="550" rx="5" ry="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
  <text x="600" y="80" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">Attestation API</text>
  
  <rect x="700" y="100" width="100" height="550" rx="5" ry="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
  <text x="750" y="80" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">KMS</text>
  
  <rect x="850" y="100" width="100" height="550" rx="5" ry="5" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="2"/>
  <text x="900" y="80" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">TEE</text>
  
  <!-- Step 1: Authentication -->
  <line x1="150" y1="130" x2="300" y2="130" stroke="#3498db" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="160" y="105" width="130" height="20" fill="#d6eaf8" rx="5" ry="5"/>
  <text x="225" y="119" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#2980b9">Connect with tenant ID</text>
  
  <line x1="300" y1="160" x2="450" y2="160" stroke="#3498db" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="325" y="135" width="100" height="20" fill="#d6eaf8" rx="5" ry="5"/>
  <text x="375" y="149" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#2980b9">Verify request</text>
  
  <line x1="450" y1="190" x2="300" y2="190" stroke="#3498db" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="325" y="165" width="100" height="20" fill="#d6eaf8" rx="5" ry="5"/>
  <text x="375" y="179" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#2980b9">Auth confirmed</text>
  
  <!-- Step 2: TEE Assignment -->
  <line x1="300" y1="220" x2="750" y2="220" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="450" y="195" width="150" height="20" fill="#d5f5e3" rx="5" ry="5"/>
  <text x="525" y="209" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#27ae60">Lookup in TEE Registry</text>
  
  <line x1="750" y1="240" x2="900" y2="240" stroke="#2ecc71" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="775" y="215" width="100" height="20" fill="#d5f5e3" rx="5" ry="5"/>
  <text x="825" y="229" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#27ae60">Select TEE</text>
  
  <!-- Step 3: Primary Verification -->
  <line x1="900" y1="270" x2="600" y2="270" stroke="#9b59b6" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="700" y="245" width="100" height="20" fill="#e8daef" rx="5" ry="5"/>
  <text x="750" y="259" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#8e44ad">Generate attestation</text>
  
  <line x1="600" y1="300" x2="150" y2="300" stroke="#9b59b6" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="300" y="275" width="150" height="20" fill="#e8daef" rx="5" ry="5"/>
  <text x="375" y="289" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#8e44ad">Send TEE attestation report</text>
  
  <!-- Step 4: Dual-Key Encryption -->
  <rect x="50" y="310" width="200" height="60" rx="5" ry="5" fill="#f9ebea" stroke="#e6b0aa" stroke-width="1"/>
  <text x="150" y="330" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#922b21">Client SDK verifies attestation</text>
  <text x="150" y="345" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#922b21">- Hardware measurements</text>
  <text x="150" y="360" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#922b21">- TEE's public key</text>
  
  <line x1="150" y1="390" x2="750" y2="390" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="375" y="365" width="150" height="20" fill="#f9ebea" rx="5" ry="5"/>
  <text x="450" y="379" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#c0392b">Request one-time key from KMS</text>
  
  <line x1="750" y1="420" x2="150" y2="420" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="375" y="395" width="150" height="20" fill="#f9ebea" rx="5" ry="5"/>
  <text x="450" y="409" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#c0392b">Provide one-time key</text>
  
  <rect x="50" y="430" width="200" height="70" rx="5" ry="5" fill="#f9ebea" stroke="#e6b0aa" stroke-width="1"/>
  <text x="150" y="450" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#922b21">Envelope Encryption:</text>
  <text x="150" y="465" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#922b21">1. Data encrypted with TEE's public key</text>
  <text x="150" y="480" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#922b21">2. Re-encrypted with one-time key</text>
  <text x="150" y="495" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#922b21">   from KMS</text>
  
  <!-- Step 5: Secondary Verification -->
  <rect x="650" y="430" width="200" height="70" rx="5" ry="5" fill="#e8f8f5" stroke="#a3e4d7" stroke-width="1"/>
  <text x="750" y="450" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#16a085">KMS Verification:</text>
  <text x="750" y="465" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a085">1. Verify TEE identity in Registry</text>
  <text x="750" y="480" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a085">2. Confirm valid attestation</text>
  <text x="750" y="495" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#16a085">3. Verify TEE authorization</text>
  
  <!-- Step 6: Data Send & Key Distribution -->
  <line x1="150" y1="520" x2="300" y2="520" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="160" y="495" width="130" height="20" fill="#fef9e7" rx="5" ry="5"/>
  <text x="225" y="509" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#d35400">Send encrypted data</text>
  
  <line x1="300" y1="540" x2="900" y2="540" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="500" y="515" width="200" height="20" fill="#fef9e7" rx="5" ry="5"/>
  <text x="600" y="529" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#d35400">Forward encrypted data</text>
  
  <line x1="750" y1="570" x2="900" y2="570" stroke="#f39c12" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="775" y="545" width="100" height="20" fill="#fef9e7" rx="5" ry="5"/>
  <text x="825" y="559" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#d35400">Share one-time key</text>
  
  <rect x="800" y="580" width="200" height="20" rx="5" ry="5" fill="#fef9e7" stroke="#e6b0aa" stroke-width="1"/>
  <text x="900" y="594" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#d35400">Decrypt &amp; process in isolation</text>
  
  <!-- Step 7: Results -->
  <line x1="900" y1="620" x2="300" y2="620" stroke="#1abc9c" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="500" y="595" width="200" height="20" fill="#e8f8f5" rx="5" ry="5"/>
  <text x="600" y="609" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a085">Return encrypted results</text>
  
  <line x1="300" y1="640" x2="150" y2="640" stroke="#1abc9c" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="175" y="615" width="100" height="20" fill="#e8f8f5" rx="5" ry="5"/>
  <text x="225" y="629" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a085">Forward results</text>
  
  <rect x="50" y="645" width="200" height="20" rx="5" ry="5" fill="#e8f8f5" stroke="#a3e4d7" stroke-width="1"/>
  <text x="150" y="659" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#16a085">Client SDK decrypts results</text>
  
  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#7f8c8d" />
    </marker>
  </defs>
</svg>
